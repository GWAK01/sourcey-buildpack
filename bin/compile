#!/bin/bash

BUILD_PATH=$1
CACHE_PATH=$2

set -e

mkdir -p $BUILD_PATH $CACHE_PATH

PERL_VERSION=5.20.2
RELEASE=r3

if [ -d $CACHE_PATH/perl-$PERL_VERSION -a -r $CACHE_PATH/perl-$PERL_VERSION/$RELEASE ]; then
   echo "        - using perl from cache ($CACHE_PATH/perl-$PERL_VERSION -> $BUILD_PATH)"
   cp --archive $CACHE_PATH/perl-$PERL_VERSION $BUILD_PATH
else 
   echo "        - rebuilding perl in $BUILD_PATH"
   `dirname $0`/../lib/language_pack/perl.sh $PERL_VERSION $BUILD_PATH /home/vcap/app/perl-$PERL_VERSION
   # a little song and dance to get directory patch into shape at runtime ...
   # I mean seriously, why does this have to be so hard ????
   mv $BUILD_PATH/home/vcap/app/perl-$PERL_VERSION $BUILD_PATH
   rm -r $BUILD_PATH/home/vcap/app
   # save our software away so that we don't have to rebuild it again
   rm -rf $CACHE_PATH/*
   cp --archive $BUILD_PATH/perl-$PERL_VERSION $CACHE_PATH 
   touch $CACHE_PATH/perl-$PERL_VERSION/$RELEASE
fi

export PATH=$BUILD_PATH/perl-$PERL_VERSION/bin:$PATH

cpanm --notest --installdeps $BUILD_PATH

cat <<APP > run_app.sh
#!/bin/bash
set -x
export PATH=\$HOME/perl-$PERL_VERSION/bin:\$PATH
exec ./app.pl prefork --listen "http://*:\$PORT"
APP

chmod 755 run_app.sh
