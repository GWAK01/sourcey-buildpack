#!/bin/bash

## other decision structure
set -o errexit
# don't try to remember where things are
set +o hashall
## do not tolerate unset variables
set -u
## quit on non 0 exit codes
set -e

## show the environment we are building in
SOURCEY=sourcey
BUILD_DIR=$1
CACHE_DIR=$2
PREFIX=$HOME/app/$SOURCEY

MYDIR=$(cd `dirname $0`/..;pwd)
MYPWD=$PWD

source $MYDIR/lib/SourceyBuildLib.inc $MYDIR

mkdir -p $BUILD_DIR $CACHE_DIR

SB=$BUILD_DIR/SourceyBuild.sh

if [ -f $SB ]; then
   MD5SUM=`md5sum $SB|awk '{print $1}'`
   if egrep -qv '^SOURCEY_REBUILD=1' $SB && test -f "$CACHE_DIR/$SOURCEY/$MD5SUM"; then
      cp --verbose --archive $CACHE_DIR/$SOURCEY $BUILD_DIR |& progressor "Restoring binaries from $CACHE_DIR"
   else
      source $SB
      mv --verbose $PREFIX $BUILD_DIR |& progressor "Moving binaries to $BUILD_DIR ready for uplading" 1
      if [ -d $CACHE_DIR/$SOURCEY ]; then
          chmod -R u+rwx $CACHE_DIR/$SOURCEY
          rm -rf $CACHE_DIR/$SOURCEY
      fi
      cp --verbose --archive $BUILD_DIR/$SOURCEY $CACHE_DIR  |& progressor "Saveing a copy of your binaries to $CACHE_DIR for future use"
      touch $CACHE_DIR/$SOURCEY/$MD5SUM
   fi
fi

if [ -r $BUILD_DIR/SourceyBuildApp.sh ]; then
   source $BUILD_DIR/SourceyBuildApp.sh
fi

chmod 755 $BUILD_DIR/SourceyStart.sh
