#!/bin/bash

## other decision structure
set -o errexit
# don't try to remember where things are
set +o hashall
## do not tolerate unset variables
set -u

## show the environment we are building in
env

SOURCEY=sourcey
BUILD_DIR=$1
CACHE_DIR=$2
PREFIX=/home/vcap/app/$SOURCEY

MYDIR=$(cd `dirname $0`/..;pwd)
source $MYDIR/lib/SourceyBuildLib.inc $MYDIR

mkdir -p $BUILD_DIR $CACHE_DIR

SB=$BUILD_DIR/SourceyBuild.sh


if [ -f $SB ]; then
   MD5SUM=`md5sum $SB`
   if [ -f $CACHE_DIR/$SOURCEY/$MD5SUM ]; then
      cp --archive $CACHE_DIR/$SOURCEY $BUILD_DIR
   else
      . $BUILD_DIR/SourceyBuild.sh
      mv $BUILD_DIR$PREFIX $BUILD_DIR
      chmod -R u+rws $CACHE_DIR/$SOURCEY
      rm -rf $CACHE_DIR/$SOURCEY
      cp --archive $BUILD_DIR/$SOURCEY $CACHE_DIR
      touch $CACHE_DIR/$SOURCEY/$MD5SUM
   fi
fi

if [ -r $BUILD_DIR/SourceyBuildApp.sh ]; then
   . $BUILD_DIR/SourceyBuildApp.sh
fi

chmod 755 $BUILD_DIR/SourceyStart.sh
